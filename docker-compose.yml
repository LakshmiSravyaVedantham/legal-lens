services:
  # ─── Nginx: Frontend + Reverse Proxy ───
  nginx:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - legallens
    restart: unless-stopped

  # ─── Backend: FastAPI ───
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    env_file: .env
    environment:
      - MONGO_URI=${MONGO_URI:-mongodb://legallens:legallens@mongodb:27017/legallens?authSource=admin}
      - CHROMA_HOST=${CHROMA_HOST:-chromadb}
      - CHROMA_PORT=${CHROMA_PORT:-8100}
    volumes:
      - uploads_data:/app/backend/data/uploads
    depends_on:
      mongodb:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    mem_limit: 2g
    networks:
      - legallens
    restart: unless-stopped

  # ─── MongoDB ───
  mongodb:
    image: mongo:7
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:-legallens}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:-legallens}
      MONGO_INITDB_DATABASE: legallens
    volumes:
      - mongo_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/init.js:ro
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    mem_limit: 1g
    networks:
      - legallens
    restart: unless-stopped

  # ─── ChromaDB: Vector Database ───
  chromadb:
    image: chromadb/chroma:0.5.7
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=false
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/heartbeat')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - legallens
    restart: unless-stopped

  # ─── Ollama: Local LLM (optional) ───
  ollama:
    image: ollama/ollama:latest
    profiles: ["ollama"]
    volumes:
      - ollama_data:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - legallens
    restart: unless-stopped

volumes:
  mongo_data:
  chroma_data:
  uploads_data:
  ollama_data:

networks:
  legallens:
    driver: bridge
